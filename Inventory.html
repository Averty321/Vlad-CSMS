<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #7f8c8d; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        .controls { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .left-controls, .right-controls { display: flex; gap: 15px; flex-wrap: wrap; }
        .search-box input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px; }
        
        .btn { padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #2980b9; }
        .btn-add { background: #2ecc71; }
        .btn-add:hover { background: #27ae60; }
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 13px; }
        .btn-delete { background: #e74c3c; padding: 5px 10px; font-size: 13px; }
        .btn-restore { background: #3498db; padding: 5px 10px; font-size: 13px; }
        .btn-excel { background: #1d6f42; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #3498db; color: white; position: sticky; top: 0; }
        tr:hover { background: #f1f8ff; }
        
        .barcode-status, .status-written-off, .status-new { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; text-align: center; display: inline-block; min-width: 80px; }
        .barcode-active { background: #d4edda; color: #155724; }
        .barcode-inactive { background: #f8d7da; color: #721c24; }
        .status-written-off { background: #fff3cd; color: #856404; }
        .status-new { background: #e8f4fc; color: #2980b9; }
        .row-written-off { background: #fff3cd !important; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; }
        
        .import-info { background: #e8f4fc; padding: 15px; border-radius: 4px; margin: 20px 0; border-left: 4px solid #3498db; }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .search-box input { width: 100%; }
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ –°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h1>
        
        <div class="stats">
            <div class="stat-card"><h3>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</h3><div class="value" id="totalItems">0</div></div>
            <div class="stat-card"><h3>–°–ø–∏—Å–∞–Ω–æ</h3><div class="value" id="writtenOffItems">0</div></div>
            <div class="stat-card"><h3>–ù–æ–≤—ã–µ</h3><div class="value" id="newItems">0</div></div>
        </div>
        
        <div class="controls">
            <div class="left-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –∏–ª–∏ –Ω–æ–º–µ—Ä—É...">
                </div>
                <button class="btn btn-add" id="addItemBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
            </div>
            <div class="right-controls">
                <button class="btn btn-excel" id="importExcelBtn">üìä –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
                <button class="btn btn-excel" id="exportExcelBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ù–æ–º–µ—Ä</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th><th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–ø–µ—Ä–∞—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h2>
            <form id="itemForm">
                <div class="form-group"><label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label><input type="text" id="itemName" required></div>
                <div class="form-group"><label>–ù–æ–º–µ—Ä *</label><input type="text" id="itemNumber" required></div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;"><label>–ü–æ —Å–ø–∏—Å–∫—É</label><input type="number" id="quantityList" min="0" value="0"></div>
                        <div style="flex: 1;"><label>–ü–æ —Ñ–∞–∫—Ç—É</label><input type="number" id="quantityFact" min="0" value="0"></div>
                    </div>
                </div>
                <div class="form-group"><label>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ *</label><input type="text" id="location" required></div>
                <div class="form-group">
                    <label>–®—Ç—Ä–∏—Ö-–∫–æ–¥ *</label>
                    <select id="barcodeStatus" required>
                        <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                    </select>
                </div>
                <div class="form-group"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label><textarea id="notes" rows="3"></textarea></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="excelModal">
        <div class="modal-content">
            <h2>–ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV</h2>
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                <div style="position: relative; display: inline-block; width: 100%;">
                    <button class="btn btn-excel" style="width: 100%">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª Excel/CSV</button>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                </div>
                <div id="fileName" style="margin-top: 10px; font-style: italic;"></div>
            </div>

            <div class="import-info">
                <h3 style="margin-top: 0;">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</h3>
                <p><strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤:</strong></p>
                <ul>
                    <li><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "Name", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–¢–æ–≤–∞—Ä"</li>
                    <li><strong>–ù–æ–º–µ—Ä:</strong> "–ù–æ–º–µ—Ä", "Number", "–ê—Ä—Ç–∏–∫—É–ª", "–ö–æ–¥", "ID"</li>
                    <li><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "Quantity", "–ö–æ–ª-–≤–æ", "Qty"</li>
                    <li><strong>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ", "Location", "–ú–µ—Å—Ç–æ", "–°–∫–ª–∞–¥"</li>
                </ul>
                <p><em>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –ù–æ–º–µ—Ä</em></p>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button class="btn" id="cancelExcelBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-excel" id="processExcelBtn" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <h2 id="confirmationTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p id="confirmationMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="btn" id="confirmCancelBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-delete" id="confirmActionBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        let inventoryData = JSON.parse(localStorage.getItem('inventoryData')) || [
            {id: 1, name: "–ù–æ—É—Ç–±—É–∫ Dell XPS 13", number: "NTP-001", quantityList: 5, quantityFact: 5, location: "–°–∫–ª–∞–¥ –ê, –ø–æ–ª–∫–∞ 2", barcodeStatus: "active", status: "active", notes: "–î–ª—è –æ—Ç–¥–µ–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"},
            {id: 2, name: "–ú–æ–Ω–∏—Ç–æ—Ä Samsung 24\"", number: "MON-002", quantityList: 10, quantityFact: 8, location: "–°–∫–ª–∞–¥ –ë, –ø–æ–ª–∫–∞ 5", barcodeStatus: "active", status: "active", notes: ""},
            {id: 3, name: "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ Logitech", number: "KEY-003", quantityList: 15, quantityFact: 12, location: "–°–∫–ª–∞–¥ –ê, –ø–æ–ª–∫–∞ 1", barcodeStatus: "inactive", status: "active", notes: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–º–µ–Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞"}
        ];

        let nextId = Math.max(...inventoryData.map(item => item.id), 0) + 1;
        let currentEditingId = null;
        let pendingAction = null;
        let pendingItemId = null;
        let importData = [];

        // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        
        function saveData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
        }

        function updateStats() {
            document.getElementById('totalItems').textContent = inventoryData.length;
            document.getElementById('writtenOffItems').textContent = inventoryData.filter(item => item.status === 'written-off').length;
            document.getElementById('newItems').textContent = inventoryData.filter(item => item.status === 'new').length;
        }

        function renderTable(data = inventoryData) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                if (item.status === 'written-off') row.classList.add('row-written-off');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.number}</td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1; text-align: center; padding: 5px; border-radius: 4px; background: #e8f4fc; color: #2980b9; font-weight: 600;">${item.quantityList}</div>
                            <div style="flex: 1; text-align: center; padding: 5px; border-radius: 4px; background: #e8f8f0; color: #27ae60; font-weight: 600;">${item.quantityFact}</div>
                        </div>
                    </td>
                    <td>${item.location}</td>
                    <td>
                        <span class="barcode-status ${item.barcodeStatus === 'active' ? 'barcode-active' : 'barcode-inactive'}">
                            ${item.barcodeStatus === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </td>
                    <td>
                        ${item.status === 'written-off' ? '<span class="status-written-off">–°–ø–∏—Å–∞–Ω–æ</span>' : 
                          item.status === 'new' ? '<span class="status-new">–ù–æ–≤—ã–π</span>' : 
                          '<span style="color: #6c757d;">–ê–∫—Ç–∏–≤–µ–Ω</span>'}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            ${item.status === 'written-off' ? 
                                `<button class="btn btn-restore" data-id="${item.id}">‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                 <button class="btn btn-delete" data-id="${item.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` :
                                `<button class="btn btn-edit" data-id="${item.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                 <button class="btn btn-delete" data-id="${item.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => editItem(parseInt(e.target.getAttribute('data-id'))));
            });
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => showConfirmation('delete', parseInt(e.target.getAttribute('data-id'))));
            });
            document.querySelectorAll('.btn-restore').forEach(btn => {
                btn.addEventListener('click', (e) => showConfirmation('restore', parseInt(e.target.getAttribute('data-id'))));
            });
            
            updateStats();
            saveData();
        }

        // ===== –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–´ –° –ü–û–ó–ò–¶–ò–Ø–ú–ò =====
        
        function addItem() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é';
            document.getElementById('itemForm').reset();
            document.getElementById('quantityList').value = '0';
            document.getElementById('quantityFact').value = '0';
            document.getElementById('itemModal').style.display = 'flex';
        }

        function editItem(id) {
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;
            
            currentEditingId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemNumber').value = item.number;
            document.getElementById('quantityList').value = item.quantityList;
            document.getElementById('quantityFact').value = item.quantityFact;
            document.getElementById('location').value = item.location;
            document.getElementById('barcodeStatus').value = item.barcodeStatus;
            document.getElementById('notes').value = item.notes || '';
            
            document.getElementById('itemModal').style.display = 'flex';
        }

        function deleteItem(id) {
            inventoryData = inventoryData.filter(item => item.id !== id);
            renderTable();
        }

        function restoreItem(id) {
            const item = inventoryData.find(item => item.id === id);
            if (item) {
                item.status = 'active';
                renderTable();
            }
        }

        // ===== –§–£–ù–ö–¶–ò–ò –í–ê–õ–ò–î–ê–¶–ò–ò =====
        
        function isNumberUnique(number, excludeId = null) {
            return !inventoryData.some(item => item.number === number && item.id !== excludeId);
        }

        function validateForm(formData, excludeId = null) {
            if (!formData.name.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ');
                return false;
            }
            if (!formData.number.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä');
                return false;
            }
            if (!isNumberUnique(formData.number, excludeId)) {
                alert('–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º');
                return false;
            }
            if (formData.quantityList < 0 || formData.quantityFact < 0) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
                return false;
            }
            if (!formData.location.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                return false;
            }
            return true;
        }

        // ===== –§–£–ù–ö–¶–ò–ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –î–ï–ô–°–¢–í–ò–ô =====
        
        function showConfirmation(action, itemId) {
            pendingAction = action;
            pendingItemId = itemId;
            
            const item = inventoryData.find(item => item.id === itemId);
            
            if (action === 'delete') {
                document.getElementById('confirmationTitle').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ';
                document.getElementById('confirmationMessage').textContent = `–£–¥–∞–ª–∏—Ç—å "${item.name}"?`;
                document.getElementById('confirmActionBtn').className = 'btn btn-delete';
                document.getElementById('confirmActionBtn').textContent = '–£–¥–∞–ª–∏—Ç—å';
            } else {
                document.getElementById('confirmationTitle').textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
                document.getElementById('confirmationMessage').textContent = `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "${item.name}"?`;
                document.getElementById('confirmActionBtn').className = 'btn btn-add';
                document.getElementById('confirmActionBtn').textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            }
            
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function executePendingAction() {
            if (pendingAction === 'delete') {
                deleteItem(pendingItemId);
            } else {
                restoreItem(pendingItemId);
            }
            document.getElementById('confirmationModal').style.display = 'none';
        }

        // ===== –§–£–ù–ö–¶–ò–ò –ò–ú–ü–û–†–¢–ê/–≠–ö–°–ü–û–†–¢–ê =====
        
        function parseExcelData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        console.log('–ù–∞—á–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞:', file.name);
                        let data = [];
                        
                        if (file.name.endsWith('.csv')) {
                            // –ü–∞—Ä—Å–∏–Ω–≥ CSV
                            const text = e.target.result;
                            const lines = text.split('\n').filter(line => line.trim());
                            
                            if (lines.length < 2) {
                                reject(new Error('CSV —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö'));
                                return;
                            }
                            
                            // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                            const firstLine = lines[0];
                            const delimiter = firstLine.includes(';') ? ';' : ',';
                            
                            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
                            console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏ CSV:', headers);
                            
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const values = line.split(delimiter).map(v => v.trim().replace(/"/g, ''));
                                const obj = {};
                                
                                for (let j = 0; j < headers.length; j++) {
                                    const header = headers[j];
                                    const value = values[j] || '';
                                    
                                    // –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                                    if (header.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || header.includes('name') || header.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || header.includes('—Ç–æ–≤–∞—Ä')) {
                                        obj.name = value;
                                    } else if (header.includes('–Ω–æ–º–µ—Ä') || header.includes('number') || header.includes('–∞—Ä—Ç–∏–∫—É–ª') || header.includes('–∫–æ–¥') || header.includes('id')) {
                                        obj.number = value;
                                    } else if (header.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || header.includes('quantity') || header.includes('–∫–æ–ª-–≤–æ') || header.includes('qty')) {
                                        obj.quantityList = parseInt(value) || 0;
                                        obj.quantityFact = parseInt(value) || 0;
                                    } else if (header.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ') || header.includes('location') || header.includes('–º–µ—Å—Ç–æ') || header.includes('—Å–∫–ª–∞–¥')) {
                                        obj.location = value;
                                    }
                                }
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                                if (obj.name && obj.number) {
                                    obj.barcodeStatus = 'active';
                                    data.push(obj);
                                    console.log('–î–æ–±–∞–≤–ª–µ–Ω –æ–±—ä–µ–∫—Ç:', obj);
                                }
                            }
                        } else {
                            // –ü–∞—Ä—Å–∏–Ω–≥ Excel
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            console.log('–î–∞–Ω–Ω—ã–µ Excel:', jsonData);
                            
                            if (jsonData.length === 0) {
                                reject(new Error('Excel —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö'));
                                return;
                            }
                            
                            jsonData.forEach(row => {
                                const obj = {};
                                const keys = Object.keys(row);
                                
                                keys.forEach(key => {
                                    const lowerKey = key.toLowerCase();
                                    const value = row[key];
                                    
                                    if (lowerKey.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || lowerKey.includes('name') || lowerKey.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || lowerKey.includes('—Ç–æ–≤–∞—Ä')) {
                                        obj.name = String(value || '');
                                    } else if (lowerKey.includes('–Ω–æ–º–µ—Ä') || lowerKey.includes('number') || lowerKey.includes('–∞—Ä—Ç–∏–∫—É–ª') || lowerKey.includes('–∫–æ–¥') || lowerKey.includes('id')) {
                                        obj.number = String(value || '');
                                    } else if (lowerKey.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || lowerKey.includes('quantity') || lowerKey.includes('–∫–æ–ª-–≤–æ') || lowerKey.includes('qty')) {
                                        obj.quantityList = parseInt(value) || 0;
                                        obj.quantityFact = parseInt(value) || 0;
                                    } else if (lowerKey.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ') || lowerKey.includes('location') || lowerKey.includes('–º–µ—Å—Ç–æ') || lowerKey.includes('—Å–∫–ª–∞–¥')) {
                                        obj.location = String(value || '');
                                    }
                                });
                                
                                if (obj.name && obj.number) {
                                    obj.barcodeStatus = 'active';
                                    data.push(obj);
                                    console.log('–î–æ–±–∞–≤–ª–µ–Ω –æ–±—ä–µ–∫—Ç –∏–∑ Excel:', obj);
                                }
                            });
                        }
                        
                        console.log('–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', data.length);
                        
                        if (data.length === 0) {
                            reject(new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.'));
                            return;
                        }
                        
                        resolve(data);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
                        reject(new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'));
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function smartImport(excelData) {
            console.log('–ù–∞—á–∞–ª–æ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:', excelData);
            
            const excelNumbers = new Set(excelData.map(item => item.number));
            let newItemsCount = 0;
            let updatedItemsCount = 0;
            
            // –ü–æ–º–µ—Ç–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–∞–∫ —Å–ø–∏—Å–∞–Ω–Ω—ã–µ
            inventoryData.forEach(item => {
                if (!excelNumbers.has(item.number) && item.status !== 'written-off') {
                    item.status = 'written-off';
                }
            });
            
            // –î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏
            excelData.forEach(excelItem => {
                const existingIndex = inventoryData.findIndex(item => item.number === excelItem.number);
                
                if (existingIndex !== -1) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–∑–∏—Ü–∏—é
                    inventoryData[existingIndex] = {
                        ...inventoryData[existingIndex],
                        ...excelItem,
                        status: 'active'
                    };
                    updatedItemsCount++;
                    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏—è:', excelItem.number);
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
                    inventoryData.push({
                        ...excelItem,
                        id: nextId++,
                        status: 'new',
                        notes: ''
                    });
                    newItemsCount++;
                    console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:', excelItem.number);
                }
            });
            
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–ø–æ—Ä—Ç–∞:', { newItemsCount, updatedItemsCount });
            return { newItemsCount, updatedItemsCount };
        }

        function exportToCSV() {
            const headers = ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–æ–º–µ—Ä', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Å–ø–∏—Å–∫—É', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Ñ–∞–∫—Ç—É', '–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–°–æ—Å—Ç–æ—è–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞', '–°—Ç–∞—Ç—É—Å', '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è'];
            const csv = [
                headers.join(','),
                ...inventoryData.map(item => [
                    `"${item.name}"`,
                    `"${item.number}"`,
                    item.quantityList,
                    item.quantityFact,
                    `"${item.location}"`,
                    `"${item.barcodeStatus === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}"`,
                    `"${item.status === 'written-off' ? '–°–ø–∏—Å–∞–Ω–æ' : item.status === 'new' ? '–ù–æ–≤—ã–π' : '–ê–∫—Ç–∏–≤–µ–Ω'}"`,
                    `"${item.notes || ''}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====
        
        document.getElementById('itemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('itemName').value,
                number: document.getElementById('itemNumber').value,
                quantityList: parseInt(document.getElementById('quantityList').value),
                quantityFact: parseInt(document.getElementById('quantityFact').value),
                location: document.getElementById('location').value,
                barcodeStatus: document.getElementById('barcodeStatus').value,
                notes: document.getElementById('notes').value
            };
            
            if (!validateForm(formData, currentEditingId)) return;
            
            if (currentEditingId) {
                const index = inventoryData.findIndex(item => item.id === currentEditingId);
                if (index !== -1) inventoryData[index] = {...inventoryData[index], ...formData};
            } else {
                inventoryData.push({...formData, id: nextId++, status: 'active'});
            }
            
            renderTable();
            document.getElementById('itemModal').style.display = 'none';
        });

        document.getElementById('searchInput').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            if (!term) return renderTable();
            
            const filtered = inventoryData.filter(item => 
                item.name.toLowerCase().includes(term) || 
                item.number.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        document.getElementById('excelFile').addEventListener('change', async function() {
            if (!this.files.length) {
                document.getElementById('fileName').textContent = '';
                document.getElementById('processExcelBtn').disabled = true;
                return;
            }
            
            const file = this.files[0];
            document.getElementById('fileName').textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`;
            document.getElementById('processExcelBtn').disabled = true;
            document.getElementById('processExcelBtn').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                importData = await parseExcelData(file);
                document.getElementById('processExcelBtn').disabled = false;
                document.getElementById('processExcelBtn').textContent = `–ò–º–ø–æ—Ä—Ç (${importData.length} –∑–∞–ø–∏—Å–µ–π)`;
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                document.getElementById('processExcelBtn').disabled = false;
                document.getElementById('processExcelBtn').textContent = '–ò–º–ø–æ—Ä—Ç';
            }
        });

        document.getElementById('processExcelBtn').addEventListener('click', function() {
            if (importData.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const result = smartImport(importData);
            renderTable();
            
            alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–ù–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${result.newItemsCount}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${result.updatedItemsCount}`);
            
            document.getElementById('excelModal').style.display = 'none';
            document.getElementById('processExcelBtn').textContent = '–ò–º–ø–æ—Ä—Ç';
        });

        // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.getElementById('addItemBtn').addEventListener('click', addItem);
        document.getElementById('importExcelBtn').addEventListener('click', () => {
            document.getElementById('excelModal').style.display = 'flex';
            document.getElementById('excelFile').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('processExcelBtn').disabled = true;
            document.getElementById('processExcelBtn').textContent = '–ò–º–ø–æ—Ä—Ç';
        });
        document.getElementById('exportExcelBtn').addEventListener('click', exportToCSV);

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('itemModal').style.display = 'none';
        });
        document.getElementById('cancelExcelBtn').addEventListener('click', () => {
            document.getElementById('excelModal').style.display = 'none';
        });
        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            document.getElementById('confirmationModal').style.display = 'none';
        });
        document.getElementById('confirmActionBtn').addEventListener('click', executePendingAction);

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
        });
    </script>
</body>
</html>
