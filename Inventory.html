<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #7f8c8d; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        .controls { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .left-controls, .right-controls { display: flex; gap: 15px; flex-wrap: wrap; }
        .search-box input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px; }
        
        .btn { padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #2980b9; }
        .btn-add { background: #2ecc71; }
        .btn-add:hover { background: #27ae60; }
        .btn-edit { background: #f39c12; padding: 5px 10px; font-size: 13px; }
        .btn-delete { background: #e74c3c; padding: 5px 10px; font-size: 13px; }
        .btn-restore { background: #3498db; padding: 5px 10px; font-size: 13px; }
        .btn-excel { background: #1d6f42; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #3498db; color: white; position: sticky; top: 0; }
        tr:hover { background: #f1f8ff; }
        
        .barcode-status, .status-written-off, .status-new { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; text-align: center; display: inline-block; min-width: 80px; }
        .barcode-active { background: #d4edda; color: #155724; }
        .barcode-inactive { background: #f8d7da; color: #721c24; }
        .status-written-off { background: #fff3cd; color: #856404; }
        .status-new { background: #e8f4fc; color: #2980b9; }
        .row-written-off { background: #fff3cd !important; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .search-box input { width: 100%; }
            table { display: block; overflow-x: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ –°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h1>
        
        <div class="stats">
            <div class="stat-card"><h3>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</h3><div class="value" id="totalItems">0</div></div>
            <div class="stat-card"><h3>–°–ø–∏—Å–∞–Ω–æ</h3><div class="value" id="writtenOffItems">0</div></div>
            <div class="stat-card"><h3>–ù–æ–≤—ã–µ</h3><div class="value" id="newItems">0</div></div>
        </div>
        
        <div class="controls">
            <div class="left-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                </div>
                <button class="btn btn-add" id="addItemBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="right-controls">
                <button class="btn btn-excel" id="importExcelBtn">üìä –ò–º–ø–æ—Ä—Ç</button>
                <button class="btn btn-excel" id="exportExcelBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ù–æ–º–µ—Ä</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th><th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–ø–µ—Ä–∞—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h2>
            <form id="itemForm">
                <div class="form-group"><label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label><input type="text" id="itemName" required></div>
                <div class="form-group"><label>–ù–æ–º–µ—Ä *</label><input type="text" id="itemNumber" required></div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <div style="display: flex; gap: 15px;">
                        <div><label>–ü–æ —Å–ø–∏—Å–∫—É</label><input type="number" id="quantityList" min="0" value="0"></div>
                        <div><label>–ü–æ —Ñ–∞–∫—Ç—É</label><input type="number" id="quantityFact" min="0" value="0"></div>
                    </div>
                </div>
                <div class="form-group"><label>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ *</label><input type="text" id="location" required></div>
                <div class="form-group">
                    <label>–®—Ç—Ä–∏—Ö-–∫–æ–¥ *</label>
                    <select id="barcodeStatus" required>
                        <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                        <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                    </select>
                </div>
                <div class="form-group"><label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label><textarea id="notes" rows="3"></textarea></div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                    <button type="button" class="btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="excelModal">
        <div class="modal-content">
            <h2>–ò–º–ø–æ—Ä—Ç –∏–∑ Excel</h2>
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                <div style="position: relative; display: inline-block; width: 100%;">
                    <button class="btn btn-excel" style="width: 100%">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                </div>
                <div id="fileName" style="margin-top: 10px; font-style: italic;"></div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" id="cancelExcelBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-excel" id="processExcelBtn" disabled>–ò–º–ø–æ—Ä—Ç</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <h2 id="confirmationTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p id="confirmationMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="btn" id="confirmCancelBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-delete" id="confirmActionBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let inventoryData = JSON.parse(localStorage.getItem('inventoryData')) || [
            {id: 1, name: "–ù–æ—É—Ç–±—É–∫ Dell XPS 13", number: "NTP-001", quantityList: 5, quantityFact: 5, location: "–°–∫–ª–∞–¥ –ê", barcodeStatus: "active", status: "active", notes: ""},
            {id: 2, name: "–ú–æ–Ω–∏—Ç–æ—Ä Samsung 24\"", number: "MON-002", quantityList: 10, quantityFact: 8, location: "–°–∫–ª–∞–¥ –ë", barcodeStatus: "active", status: "active", notes: ""},
            {id: 3, name: "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ Logitech", number: "KEY-003", quantityList: 15, quantityFact: 12, location: "–°–∫–ª–∞–¥ –ê", barcodeStatus: "inactive", status: "active", notes: ""}
        ];

        let nextId = Math.max(...inventoryData.map(item => item.id), 0) + 1;
        let currentEditingId = null;
        let pendingAction = null;
        let pendingItemId = null;

        function saveData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
        }

        function updateStats() {
            document.getElementById('totalItems').textContent = inventoryData.length;
            document.getElementById('writtenOffItems').textContent = inventoryData.filter(item => item.status === 'written-off').length;
            document.getElementById('newItems').textContent = inventoryData.filter(item => item.status === 'new').length;
        }

        function renderTable(data = inventoryData) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                if (item.status === 'written-off') row.classList.add('row-written-off');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.number}</td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <div style="flex: 1; text-align: center; padding: 5px; border-radius: 4px; background: #e8f4fc; color: #2980b9;">${item.quantityList}</div>
                            <div style="flex: 1; text-align: center; padding: 5px; border-radius: 4px; background: #e8f8f0; color: #27ae60;">${item.quantityFact}</div>
                        </div>
                    </td>
                    <td>${item.location}</td>
                    <td>
                        <span class="barcode-status ${item.barcodeStatus === 'active' ? 'barcode-active' : 'barcode-inactive'}">
                            ${item.barcodeStatus === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </td>
                    <td>
                        ${item.status === 'written-off' ? '<span class="status-written-off">–°–ø–∏—Å–∞–Ω–æ</span>' : 
                          item.status === 'new' ? '<span class="status-new">–ù–æ–≤—ã–π</span>' : 
                          '<span style="color: #6c757d;">–ê–∫—Ç–∏–≤–µ–Ω</span>'}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            ${item.status === 'written-off' ? 
                                `<button class="btn btn-restore" data-id="${item.id}">‚Üª</button>
                                 <button class="btn btn-delete" data-id="${item.id}">üóëÔ∏è</button>` :
                                `<button class="btn btn-edit" data-id="${item.id}">‚úèÔ∏è</button>
                                 <button class="btn btn-delete" data-id="${item.id}">üóëÔ∏è</button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => editItem(parseInt(e.target.getAttribute('data-id'))));
            });
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => showConfirmation('delete', parseInt(e.target.getAttribute('data-id'))));
            });
            document.querySelectorAll('.btn-restore').forEach(btn => {
                btn.addEventListener('click', (e) => showConfirmation('restore', parseInt(e.target.getAttribute('data-id'))));
            });
            
            updateStats();
            saveData();
        }

        function addItem() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é';
            document.getElementById('itemForm').reset();
            document.getElementById('itemModal').style.display = 'flex';
        }

        function editItem(id) {
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;
            
            currentEditingId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é';
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemNumber').value = item.number;
            document.getElementById('quantityList').value = item.quantityList;
            document.getElementById('quantityFact').value = item.quantityFact;
            document.getElementById('location').value = item.location;
            document.getElementById('barcodeStatus').value = item.barcodeStatus;
            document.getElementById('notes').value = item.notes || '';
            
            document.getElementById('itemModal').style.display = 'flex';
        }

        function deleteItem(id) {
            inventoryData = inventoryData.filter(item => item.id !== id);
            renderTable();
        }

        function restoreItem(id) {
            const item = inventoryData.find(item => item.id === id);
            if (item) {
                item.status = 'active';
                renderTable();
            }
        }

        function isNumberUnique(number, excludeId = null) {
            return !inventoryData.some(item => item.number === number && item.id !== excludeId);
        }

        function validateForm(formData, excludeId = null) {
            if (!formData.name.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ');
                return false;
            }
            if (!formData.number.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä');
                return false;
            }
            if (!isNumberUnique(formData.number, excludeId)) {
                alert('–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º');
                return false;
            }
            if (formData.quantityList < 0 || formData.quantityFact < 0) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º');
                return false;
            }
            if (!formData.location.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                return false;
            }
            return true;
        }

        function showConfirmation(action, itemId) {
            pendingAction = action;
            pendingItemId = itemId;
            
            const item = inventoryData.find(item => item.id === itemId);
            
            if (action === 'delete') {
                document.getElementById('confirmationTitle').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ';
                document.getElementById('confirmationMessage').textContent = `–£–¥–∞–ª–∏—Ç—å "${item.name}"?`;
                document.getElementById('confirmActionBtn').className = 'btn btn-delete';
                document.getElementById('confirmActionBtn').textContent = '–£–¥–∞–ª–∏—Ç—å';
            } else {
                document.getElementById('confirmationTitle').textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
                document.getElementById('confirmationMessage').textContent = `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "${item.name}"?`;
                document.getElementById('confirmActionBtn').className = 'btn btn-add';
                document.getElementById('confirmActionBtn').textContent = '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            }
            
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function executePendingAction() {
            if (pendingAction === 'delete') {
                deleteItem(pendingItemId);
            } else {
                restoreItem(pendingItemId);
            }
            document.getElementById('confirmationModal').style.display = 'none';
        }

        function parseExcelData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        let data = [];
                        
                        if (file.name.endsWith('.csv')) {
                            const text = e.target.result;
                            const lines = text.split('\n');
                            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                            
                            for (let i = 1; i < lines.length; i++) {
                                if (!lines[i].trim()) continue;
                                const obj = {};
                                const currentline = lines[i].split(',');
                                
                                for (let j = 0; j < headers.length; j++) {
                                    const header = headers[j];
                                    let value = currentline[j] ? currentline[j].trim().replace(/"/g, '') : '';
                                    
                                    if (header.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || header.includes('name')) {
                                        obj.name = value;
                                    } else if (header.includes('–Ω–æ–º–µ—Ä') || header.includes('number')) {
                                        obj.number = value;
                                    } else if (header.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || header.includes('quantity')) {
                                        obj.quantityList = parseInt(value) || 0;
                                        obj.quantityFact = parseInt(value) || 0;
                                    } else if (header.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ') || header.includes('location')) {
                                        obj.location = value;
                                    }
                                }
                                
                                if (obj.name && obj.number) {
                                    obj.barcodeStatus = 'active';
                                    data.push(obj);
                                }
                            }
                        } else {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            
                            if (jsonData.length < 2) return resolve([]);
                            
                            const headers = jsonData[0].map(h => h ? h.toString().toLowerCase().trim() : '');
                            
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                const obj = {};
                                
                                for (let j = 0; j < headers.length; j++) {
                                    const header = headers[j];
                                    let value = row[j] ? row[j].toString().trim() : '';
                                    
                                    if (header.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || header.includes('name')) {
                                        obj.name = value;
                                    } else if (header.includes('–Ω–æ–º–µ—Ä') || header.includes('number')) {
                                        obj.number = value;
                                    } else if (header.includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') || header.includes('quantity')) {
                                        obj.quantityList = parseInt(value) || 0;
                                        obj.quantityFact = parseInt(value) || 0;
                                    } else if (header.includes('—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ') || header.includes('location')) {
                                        obj.location = value;
                                    }
                                }
                                
                                if (obj.name && obj.number) {
                                    obj.barcodeStatus = 'active';
                                    data.push(obj);
                                }
                            }
                        }
                        
                        resolve(data);
                    } catch (error) {
                        reject(new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞'));
                    }
                };
                
                reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'));
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            });
        }

        function smartImport(excelData) {
            const excelNumbers = new Set(excelData.map(item => item.number));
            
            let newItemsCount = 0;
            let updatedItemsCount = 0;
            
            inventoryData.forEach(item => {
                if (!excelNumbers.has(item.number) && item.status !== 'written-off') {
                    item.status = 'written-off';
                }
            });
            
            excelData.forEach(excelItem => {
                const existing = inventoryData.find(item => item.number === excelItem.number);
                if (existing) {
                    Object.assign(existing, {...excelItem, status: 'active'});
                    updatedItemsCount++;
                } else {
                    inventoryData.push({...excelItem, id: nextId++, status: 'new'});
                    newItemsCount++;
                }
            });
            
            return { newItemsCount, updatedItemsCount };
        }

        function exportToCSV() {
            const headers = ['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ù–æ–º–µ—Ä', '–ö–æ–ª-–≤–æ —Å–ø–∏—Å–æ–∫', '–ö–æ–ª-–≤–æ —Ñ–∞–∫—Ç', '–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ', '–®—Ç—Ä–∏—Ö-–∫–æ–¥', '–°—Ç–∞—Ç—É—Å'];
            const csv = [
                headers.join(','),
                ...inventoryData.map(item => [
                    `"${item.name}"`, `"${item.number}"`, item.quantityList, item.quantityFact,
                    `"${item.location}"`, `"${item.barcodeStatus}"`, `"${item.status}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.csv';
            a.click();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('itemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('itemName').value,
                number: document.getElementById('itemNumber').value,
                quantityList: parseInt(document.getElementById('quantityList').value),
                quantityFact: parseInt(document.getElementById('quantityFact').value),
                location: document.getElementById('location').value,
                barcodeStatus: document.getElementById('barcodeStatus').value,
                notes: document.getElementById('notes').value
            };
            
            if (!validateForm(formData, currentEditingId)) return;
            
            if (currentEditingId) {
                const index = inventoryData.findIndex(item => item.id === currentEditingId);
                if (index !== -1) inventoryData[index] = {...inventoryData[index], ...formData};
            } else {
                inventoryData.push({...formData, id: nextId++, status: 'active'});
            }
            
            renderTable();
            document.getElementById('itemModal').style.display = 'none';
        });

        document.getElementById('searchInput').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            if (!term) return renderTable();
            
            const filtered = inventoryData.filter(item => 
                item.name.toLowerCase().includes(term) || 
                item.number.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

        document.getElementById('excelFile').addEventListener('change', async function() {
            if (!this.files.length) return;
            
            document.getElementById('fileName').textContent = `–§–∞–π–ª: ${this.files[0].name}`;
            document.getElementById('processExcelBtn').disabled = true;
            document.getElementById('processExcelBtn').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            try {
                const data = await parseExcelData(this.files[0]);
                const result = smartImport(data);
                renderTable();
                
                alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n–ù–æ–≤—ã—Ö: ${result.newItemsCount}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${result.updatedItemsCount}`);
                document.getElementById('excelModal').style.display = 'none';
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
            
            document.getElementById('processExcelBtn').disabled = false;
            document.getElementById('processExcelBtn').textContent = '–ò–º–ø–æ—Ä—Ç';
        });

        document.getElementById('addItemBtn').addEventListener('click', addItem);
        document.getElementById('importExcelBtn').addEventListener('click', () => {
            document.getElementById('excelModal').style.display = 'flex';
        });
        document.getElementById('exportExcelBtn').addEventListener('click', exportToCSV);

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('itemModal').style.display = 'none';
        });
        document.getElementById('cancelExcelBtn').addEventListener('click', () => {
            document.getElementById('excelModal').style.display = 'none';
        });
        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            document.getElementById('confirmationModal').style.display = 'none';
        });
        document.getElementById('confirmActionBtn').addEventListener('click', executePendingAction);

        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
            document.getElementById('processExcelBtn').disabled = false;
            document.getElementById('processExcelBtn').textContent = '–ò–º–ø–æ—Ä—Ç';
        });
    </script>
</body>
</html>
