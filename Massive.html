<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка наклеек</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        button {
            margin-top: 10px;
            padding: 8px 16px;
            cursor: pointer;
        }
        .group-header {
            background-color: #f0f0f0;
            padding: 10px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<h1>Настройка наклеек</h1>
<label for="stickerNumber">Номер наклейки:</label>
<input type="number" id="stickerNumber" required>
<br>
<label for="size">Размер наклеек:</label>
<select id="size">
    <option value="16">16 мм</option>
    <option value="10">10 мм</option>
</select>
<br>
<button id="createTable">Создать таблицу</button>
<button id="clearData" style="display:none;">Очистить страницу</button>
<button id="groupData" style="display:none;">Сгруппировать</button>
<button id="fillTypes" style="display:none;">Заполнить пустые ячейки</button>

<div id="tableContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    let isGrouped = false;
    let deviceTypes = new Set();
    let accountNumbers = new Set();
    let ranges = new Set();

    // Функция для создания безопасного имени файла
    function safeFileName(name) {
        return name.replace(/[^\wа-яА-Я\s-]/gi, '_').substring(0, 100);
    }

    document.getElementById('createTable').addEventListener('click', function() {
        const stickerNumber = parseInt(document.getElementById('stickerNumber').value);
        const size = parseInt(document.getElementById('size').value);
        const totalColumns = size === 16 ? 64 : 144;
        const tableContainer = document.getElementById('tableContainer');

        let tableHTML = `<table id="outputTable"><tr><th>#</th><th>Номер наклейки</th><th>Номер квитанции/счета</th><th>Тип прибора</th><th>Диапазон</th><th>Номер прибора</th></tr>`;
        
        for (let i = 0; i < totalColumns; i++) {
            const stickerNum = stickerNumber + i;
            tableHTML += `<tr>
                <td>${i + 1}</td>
                <td>${stickerNum}</td>
                <td contenteditable="true" class="account-number"></td>
                <td contenteditable="true" class="device-type"></td>
                <td contenteditable="true" class="range"></td>
                <td contenteditable="true" class="device-number"></td>
            </tr>`;
        }
        tableHTML += `</table>
            <button id="saveMainTable">Сохранить основную таблицу</button>`;
        
        tableContainer.innerHTML = tableHTML;
        document.getElementById('clearData').style.display = 'block';
        document.getElementById('groupData').style.display = 'block';
        document.getElementById('fillTypes').style.display = 'block';
        
        // Сохраняем начальные данные
        localStorage.setItem('stickerNumber', stickerNumber);
        localStorage.setItem('size', size);
        
        // Добавляем обработчик для новой кнопки
        document.getElementById('saveMainTable').addEventListener('click', function() {
            const table = document.getElementById('outputTable');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Основная таблица"});
            XLSX.writeFile(wb, `Основная_таблица.xlsx`);
        });
        
        // Настраиваем обработчики событий для редактируемых ячеек
        const cells = tableContainer.querySelectorAll('td[contenteditable="true"]');
        cells.forEach(cell => {
            cell.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const row = cell.parentNode;
                    const nextRow = row.nextElementSibling;
                    
                    if (nextRow) {
                        const cellIndex = Array.from(row.cells).indexOf(cell);
                        nextRow.cells[cellIndex].focus();
                    }
                }
            });
        });
    });

    document.getElementById('fillTypes').addEventListener('click', function() {
        const table = document.getElementById('outputTable');
        if (!table) return;
        
        const rows = table.rows;
        let lastAccount = '';
        let lastDeviceType = '';
        let lastRange = '';
        
        for (let i = 1; i < rows.length; i++) {
            const accountCell = rows[i].cells[2];
            const deviceTypeCell = rows[i].cells[3];
            const rangeCell = rows[i].cells[4];
            
            if (accountCell.textContent.trim()) {
                lastAccount = accountCell.textContent.trim();
            } else if (lastAccount) {
                accountCell.textContent = lastAccount;
            }
            
            if (deviceTypeCell.textContent.trim()) {
                lastDeviceType = deviceTypeCell.textContent.trim();
            } else if (lastDeviceType) {
                deviceTypeCell.textContent = lastDeviceType;
            }
            
            if (rangeCell.textContent.trim()) {
                lastRange = rangeCell.textContent.trim();
            } else if (lastRange) {
                rangeCell.textContent = lastRange;
            }
        }
    });

    document.getElementById('groupData').addEventListener('click', function() {
        if (isGrouped) return;
        
        const table = document.getElementById('outputTable');
        if (!table) return;
        
        const rows = table.querySelectorAll('tr');
        let groupedData = {};
        
        // Собираем данные с группировкой по трем параметрам
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].cells;
            const sticker = cells[1].textContent.trim();
            const account = cells[2].textContent.trim() || "Без номера";
            const deviceType = cells[3].textContent.trim() || "Без типа";
            const range = cells[4].textContent.trim() || "Без диапазона";
            const deviceNumber = cells[5].textContent.trim();
            
            // Создаем составной ключ для группировки
            const groupKey = `${account}_${deviceType}_${range}`;
            
            if (!groupedData[groupKey]) {
                groupedData[groupKey] = {
                    account: account,
                    deviceType: deviceType,
                    range: range,
                    items: []
                };
            }
            
            groupedData[groupKey].items.push({
                sticker: sticker,
                deviceNumber: deviceNumber
            });
        }
        
        // Создаем контейнер для группированных таблиц
        const newTablesContainer = document.createElement('div');
        newTablesContainer.id = 'groupedTables';
        
        // Генерируем таблицы для каждой группы
        for (const groupKey in groupedData) {
            const group = groupedData[groupKey];
            
            // Создаем уникальное имя для файла
            const fileName = `${safeFileName(group.account)}_${safeFileName(group.deviceType)}_${safeFileName(group.range)}`;
            
            const groupHeader = document.createElement('div');
            groupHeader.className = 'group-header';
            groupHeader.innerHTML = `
                <h3>Группа: ${group.account} | ${group.deviceType} | ${group.range}</h3>
                <p>Количество приборов: ${group.items.length}</p>
            `;
            newTablesContainer.appendChild(groupHeader);
            
            let tableHTML = `<table class="group-table" data-group="${fileName}">
                <tr>
                    <th>Номер наклейки</th>
                    <th>Номер прибора</th>
                </tr>`;
            
            group.items.forEach(item => {
                tableHTML += `
                    <tr>
                        <td>${item.sticker}</td>
                        <td>${item.deviceNumber}</td>
                    </tr>`;
            });
            
            tableHTML += `</table>
                <button class="save-group-btn" data-group="${fileName}"
                    data-account="${group.account}"
                    data-device-type="${group.deviceType}"
                    data-range="${group.range}">
                    Сохранить группу
                </button><br><br>`;
            
            newTablesContainer.innerHTML += tableHTML;
        }
        
        // Добавляем контейнер на страницу
        document.getElementById('tableContainer').appendChild(newTablesContainer);
        isGrouped = true;
        
        // Добавляем обработчики для кнопок сохранения
        document.querySelectorAll('.save-group-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const groupKey = this.getAttribute('data-group');
                const account = this.getAttribute('data-account');
                const deviceType = this.getAttribute('data-device-type');
                const range = this.getAttribute('data-range');
                
                // Находим таблицу группы
                const table = document.querySelector(`.group-table[data-group="${groupKey}"]`);
                
                // Создаем книгу Excel
                const wb = XLSX.utils.book_new();
                
                // Добавляем метаданные
                const metaData = [
                    ['Группировка данных'],
                    ['Номер квитанции/счета', account],
                    ['Тип прибора', deviceType],
                    ['Диапазон', range],
                    [],
                    ['Данные приборов']
                ];
                
                // Получаем данные таблицы
                const tableData = XLSX.utils.table_to_sheet(table);
                
                // Объединяем метаданные с данными таблицы
                XLSX.utils.sheet_add_aoa(metaData, tableData, {origin: 'A1'});
                
                // Рассчитываем смещение для данных таблицы
                const tableStart = metaData.length + 1;
                XLSX.utils.sheet_add_dom(table, tableData, {origin: `A${tableStart}`});
                
                // Добавляем лист в книгу
                XLSX.utils.book_append_sheet(wb, tableData, groupKey.substring(0, 31));
                
                // Сохраняем файл
                XLSX.writeFile(wb, `${groupKey}.xlsx`);
            });
        });
    });

    document.getElementById('clearData').addEventListener('click', function() {
        localStorage.removeItem('stickerData');
        localStorage.removeItem('stickerNumber');
        localStorage.removeItem('size');
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('clearData').style.display = 'none';
        document.getElementById('groupData').style.display = 'none';
        document.getElementById('fillTypes').style.display = 'none';
        isGrouped = false;
        deviceTypes.clear();
        accountNumbers.clear();
        ranges.clear();
    });

    window.onload = function() {
        const savedData = localStorage.getItem('stickerData');
        if (savedData) {
            document.getElementById('tableContainer').innerHTML = savedData;
            document.getElementById('clearData').style.display = 'block';
            document.getElementById('groupData').style.display = 'block';
            document.getElementById('fillTypes').style.display = 'block';
            
            const stickerNumber = localStorage.getItem('stickerNumber');
            const size = localStorage.getItem('size');
            if (stickerNumber) document.getElementById('stickerNumber').value = stickerNumber;
            if (size) document.getElementById('size').value = size;
            
            // Восстанавливаем accountNumbers, deviceTypes и ranges из таблицы
            const table = document.getElementById('outputTable');
            if (table) {
                const accountCells = table.querySelectorAll('.account-number');
                accountCells.forEach(cell => {
                    const value = cell.textContent.trim();
                    if (value) accountNumbers.add(value);
                });
                
                const typeCells = table.querySelectorAll('.device-type');
                typeCells.forEach(cell => {
                    const value = cell.textContent.trim();
                    if (value) deviceTypes.add(value);
                });
                
                const rangeCells = table.querySelectorAll('.range');
                rangeCells.forEach(cell => {
                    const value = cell.textContent.trim();
                    if (value) ranges.add(value);
                });
                
                // Настраиваем обработчики событий
                const cells = table.querySelectorAll('td[contenteditable="true"]');
                cells.forEach(cell => {
                    cell.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const row = cell.parentNode;
                            const nextRow = row.nextElementSibling;
                            
                            if (nextRow) {
                                const cellIndex = Array.from(row.cells).indexOf(cell);
                                nextRow.cells[cellIndex].focus();
                            }
                        }
                    });
                });
            }
        }
    };
</script>

</body>
</html>
