<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор наклеек для приборов</title>
    <style>
        /* Все стили остаются без изменений */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
            color: #003366;
            line-height: 1.6;
        }
        
        h1 {
            color: #005b96;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 500;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 91, 150, 0.1);
            border: 1px solid #d1e3f6;
        }
        
        label {
            display: inline-block;
            width: 180px;
            margin-bottom: 12px;
            color: #005b96;
            font-weight: 500;
        }
        
        input, select {
            padding: 10px;
            width: 220px;
            margin-bottom: 12px;
            border: 1px solid #b8d4f0;
            border-radius: 4px;
            background-color: white;
            color: #003366;
        }
        
        button {
            padding: 10px 18px;
            margin-right: 12px;
            margin-top: 12px;
            cursor: pointer;
            background: #0077cc;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 91, 150, 0.1);
        }
        
        button:hover {
            background: #005fa3;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #b8d4f0;
            cursor: not-allowed;
            transform: none;
        }
        
        table {
            margin-top: 25px;
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 91, 150, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            border: 1px solid #d1e3f6;
            padding: 12px;
            text-align: center;
        }
        
        th {
            background-color: #0077cc;
            color: white;
            position: sticky;
            top: 0;
            font-weight: 500;
        }
        
        tr:nth-child(even) {
            background-color: #f5faff;
        }
        
        .editable {
            background: #e6f2ff;
        }
        
        .group-header {
            background-color: #0077cc;
            color: white;
            padding: 15px;
            margin-top: 25px;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0, 91, 150, 0.1);
        }
        
        .group-container {
            margin-bottom: 35px;
            border: 1px solid #d1e3f6;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 91, 150, 0.1);
        }
        
        .save-group-btn {
            background: #00a0e9;
            float: right;
        }
        
        .save-group-btn:hover {
            background: #0088c7;
        }
        
        #tableContainer {
            max-height: 650px;
            overflow-y: auto;
            margin-top: 25px;
            padding: 5px;
        }
        
        /* Стиль для скролла */
        #tableContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #tableContainer::-webkit-scrollbar-track {
            background: #f0f8ff;
        }
        
        #tableContainer::-webkit-scrollbar-thumb {
            background: #0077cc;
            border-radius: 4px;
        }
        
        /* Стили для автодополнения */
        .autocomplete-list {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .autocomplete-list li {
            padding: 5px;
            cursor: pointer;
        }
        
        .autocomplete-list li:hover {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <!-- HTML-структура остается без изменений -->
    <h1>Настройка наклеек</h1>
    
    <div class="controls">
        <label for="stickerNumber">Начальный номер наклейки:</label>
        <input type="number" id="stickerNumber" min="1" required>
        <br>
        <label for="size">Размер наклейки:</label>
        <select id="size">
            <option value="16">16 мм (64 наклейки)</option>
            <option value="10">10 мм (144 наклейки)</option>
        </select>
        <br>
        <button id="createTable">Создать таблицу</button>
        <button id="clearData" disabled>Очистить страницу</button>
        <button id="groupData" disabled>Сгруппировать</button>
        <button id="fillEmpty" disabled>Заполнить пустые ячейки</button>
        <button id="saveAll" disabled>Сохранить все данные</button>
    </div>

    <div id="tableContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let isGrouped = false;
        let originalTableData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            
            document.getElementById('createTable').addEventListener('click', createTable);
            document.getElementById('clearData').addEventListener('click', clearData);
            document.getElementById('groupData').addEventListener('click', toggleGrouping);
            document.getElementById('fillEmpty').addEventListener('click', fillEmptyCells);
            document.getElementById('saveAll').addEventListener('click', exportAllToExcel);
        });
        
        // Все остальные функции остаются без изменений, кроме fillEmptyCells
        
        function fillEmptyCells() {
            const table = document.getElementById('outputTable');
            if (!table) return;

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            let filledCount = 0;

            // 1. Заполняем номера приборов (если пустые)
            rows.forEach(row => {
                const deviceNumCell = row.cells[5];
                if (!deviceNumCell.textContent.trim()) {
                    const stickerNum = row.cells[1].textContent;
                    deviceNumCell.textContent = stickerNum;
                    filledCount++;
                }
            });

            // 2. Улучшенный алгоритм группового заполнения
            const columnsToFill = [
                { index: 2, name: 'account-number' }, // Номер квитанции
                { index: 3, name: 'device-type' },    // Тип прибора
                { index: 4, name: 'range' }           // Диапазон
            ];

            columnsToFill.forEach(column => {
                let lastValue = null;
                let startIndex = null;
                
                rows.forEach((row, index) => {
                    const currentCell = row.cells[column.index];
                    const currentValue = currentCell.textContent.trim();
                    
                    if (currentValue) {
                        if (lastValue === currentValue) {
                            // Продолжаем текущую группу
                        } else {
                            // Завершаем предыдущую группу (если есть)
                            if (lastValue !== null && startIndex !== null) {
                                fillGroup(rows, startIndex, index - 1, column.index, lastValue);
                                filledCount += (index - 1 - startIndex);
                            }
                            // Начинаем новую группу
                            startIndex = index;
                            lastValue = currentValue;
                        }
                    }
                    // Пустые строки автоматически включаются в текущую группу
                });
                
                // Заполняем последнюю группу
                if (lastValue !== null && startIndex !== null) {
                    fillGroup(rows, startIndex, rows.length - 1, column.index, lastValue);
                    filledCount += (rows.length - 1 - startIndex);
                }
            });

            if (filledCount > 0) {
                saveDataToLocalStorage();
                alert(`Заполнено ${filledCount} пустых ячеек:\n- Номера приборов заменены на номера клеймов\n- Типы, счета и диапазоны заполнены по группам`);
            } else {
                alert("Нет пустых ячеек для заполнения по заданным правилам");
            }
        }
        
        // Новая вспомогательная функция для заполнения группы
        function fillGroup(rows, startIdx, endIdx, colIdx, value) {
            for (let i = startIdx; i <= endIdx; i++) {
                const cell = rows[i].cells[colIdx];
                if (!cell.textContent.trim()) {
                    cell.textContent = value;
                }
            }
        }

        // Все остальные функции (createTable, setupEditableCells, toggleGrouping и т.д.)
        // остаются без изменений как в предыдущей версии кода
        // ...
        
    </script>
</body>
</html>
