<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор наклеек для приборов</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .controls {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        label {
            display: inline-block;
            width: 150px;
            margin-bottom: 10px;
        }
        input, select {
            padding: 8px;
            width: 200px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            margin-top: 10px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .editable {
            background: #fffde7;
        }
        .group-header {
            background-color: #e0e0e0;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .group-container {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .save-group-btn {
            background: #2196F3;
        }
        .save-group-btn:hover {
            background: #0b7dda;
        }
        #tableContainer {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Настройка наклеек</h1>
    
    <div class="controls">
        <label for="stickerNumber">Начальный номер наклейки:</label>
        <input type="number" id="stickerNumber" min="1" required>
        <br>
        <label for="size">Размер наклеек:</label>
        <select id="size">
            <option value="16">16 мм (64 наклейки)</option>
            <option value="10">10 мм (144 наклейки)</option>
        </select>
        <br>
        <button id="createTable">Создать таблицу</button>
        <button id="clearData" disabled>Очистить страницу</button>
        <button id="groupData" disabled>Сгруппировать</button>
        <button id="fillTypes" disabled>Заполнить пустые ячейки</button>
        <button id="saveAll" disabled>Сохранить все данные</button>
    </div>

    <div id="tableContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let isGrouped = false;
        let originalTableData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            
            document.getElementById('createTable').addEventListener('click', createTable);
            document.getElementById('clearData').addEventListener('click', clearData);
            document.getElementById('groupData').addEventListener('click', groupData);
            document.getElementById('fillTypes').addEventListener('click', fillEmptyCells);
            document.getElementById('saveAll').addEventListener('click', saveAllData);
        });
        
        function createTable() {
            const stickerNumber = parseInt(document.getElementById('stickerNumber').value);
            const size = document.getElementById('size').value;
            
            if (isNaN(stickerNumber)) {
                alert('Пожалуйста, введите начальный номер наклейки');
                return;
            }
            
            const totalRows = size === "16" ? 64 : 144;
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = '';
            
            let tableHTML = `
                <table id="outputTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Номер наклейки</th>
                            <th>Номер квитанции/счета</th>
                            <th>Тип прибора</th>
                            <th>Диапазон</th>
                            <th>Номер прибора</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (let i = 0; i < totalRows; i++) {
                tableHTML += `
                    <tr data-original-index="${i}">
                        <td>${i + 1}</td>
                        <td>${stickerNumber + i}</td>
                        <td class="editable account-number" contenteditable="true"></td>
                        <td class="editable device-type" contenteditable="true"></td>
                        <td class="editable range" contenteditable="true"></td>
                        <td class="editable device-number" contenteditable="true"></td>
                    </tr>
                `;
            }
            
            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
            
            document.getElementById('clearData').disabled = false;
            document.getElementById('groupData').disabled = false;
            document.getElementById('fillTypes').disabled = false;
            document.getElementById('saveAll').disabled = false;
            
            saveDataToLocalStorage();
            setupEditableCells();
        }
        
        function setupEditableCells() {
            const cells = document.querySelectorAll('td[contenteditable="true"]');
            
            cells.forEach(cell => {
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const row = cell.parentNode;
                        const nextRow = row.nextElementSibling;
                        
                        if (nextRow) {
                            const cellIndex = Array.from(row.cells).indexOf(cell);
                            nextRow.cells[cellIndex].focus();
                        }
                    }
                });
                
                cell.addEventListener('blur', saveDataToLocalStorage);
            });
        }
        
        function fillEmptyCells() {
            const table = document.getElementById('outputTable');
            if (!table) return;
            
            const columnsToFill = [2, 3, 4, 5]; // Индексы столбцов
            const rows = table.querySelectorAll('tbody tr');
            let filledCells = 0;
            
            columnsToFill.forEach(columnIndex => {
                let lastValue = '';
                
                // Сверху вниз
                rows.forEach(row => {
                    const cell = row.cells[columnIndex];
                    const currentValue = cell.textContent.trim();
                    
                    if (currentValue) {
                        lastValue = currentValue;
                    } else if (lastValue) {
                        cell.textContent = lastValue;
                        filledCells++;
                    }
                });
                
                // Снизу вверх
                lastValue = '';
                for (let i = rows.length - 1; i >= 0; i--) {
                    const cell = rows[i].cells[columnIndex];
                    const currentValue = cell.textContent.trim();
                    
                    if (currentValue) {
                        lastValue = currentValue;
                    } else if (lastValue) {
                        cell.textContent = lastValue;
                        filledCells++;
                    }
                }
            });
            
            saveDataToLocalStorage();
            alert(`Заполнено ${filledCells} пустых ячеек!`);
        }
        
        function groupData() {
            if (isGrouped) {
                restoreOriginalTable();
                return;
            }
            
            const table = document.getElementById('outputTable');
            if (!table) return;
            
            originalTableData = Array.from(table.rows).map(row => Array.from(row.cells).map(cell => cell.innerHTML));
            
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const groups = {};
            
            rows.forEach(row => {
                const account = row.cells[2].textContent.trim();
                const deviceType = row.cells[3].textContent.trim();
                const range = row.cells[4].textContent.trim();
                
                if (!account && !deviceType && !range) return;
                
                const groupKey = `${account || 'Без номера'}|${deviceType || 'Без типа'}|${range || 'Без диапазона'}`;
                
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        account: account,
                        deviceType: deviceType,
                        range: range,
                        rows: []
                    };
                }
                
                groups[groupKey].rows.push(row.outerHTML);
            });
            
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = '';
            
            for (const [key, group] of Object.entries(groups)) {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-container';
                
                const [account, deviceType, range] = key.split('|');
                
                groupContainer.innerHTML = `
                    <div class="group-header">
                        Номер квитанции: ${account} | 
                        Тип прибора: ${deviceType} | 
                        Диапазон: ${range}
                        <button class="save-group-btn" 
                                data-account="${account}" 
                                data-device-type="${deviceType}" 
                                data-range="${range}">
                            Сохранить группу
                        </button>
                    </div>
                    <table class="group-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Номер наклейки</th>
                                <th>Номер квитанции/счета</th>
                                <th>Тип прибора</th>
                                <th>Диапазон</th>
                                <th>Номер прибора</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${group.rows.join('')}
                        </tbody>
                    </table>
                `;
                
                tableContainer.appendChild(groupContainer);
            }
            
            document.querySelectorAll('.save-group-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const account = this.getAttribute('data-account');
                    const deviceType = this.getAttribute('data-device-type');
                    const range = this.getAttribute('data-range');
                    
                    const groupTable = this.closest('.group-container').querySelector('.group-table');
                    saveGroupToExcel(groupTable, account, deviceType, range);
                });
            });
            
            isGrouped = true;
            document.getElementById('groupData').textContent = 'Вернуться к таблице';
        }
        
        function restoreOriginalTable() {
            if (!originalTableData.length) return;
            
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = `
                <table id="outputTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Номер наклейки</th>
                            <th>Номер квитанции/счета</th>
                            <th>Тип прибора</th>
                            <th>Диапазон</th>
                            <th>Номер прибора</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${originalTableData.slice(1).map(row => `
                            <tr>
                                ${row.map((cell, i) => 
                                    i > 0 ? `<td class="${i === 2 ? 'account-number' : i === 3 ? 'device-type' : i === 4 ? 'range' : i === 5 ? 'device-number' : ''} ${i > 1 ? 'editable' : ''}" ${i > 1 ? 'contenteditable="true"' : ''}>${cell}</td>` 
                                    : `<td>${cell}</td>`
                                ).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            setupEditableCells();
            isGrouped = false;
            document.getElementById('groupData').textContent = 'Сгруппировать';
        }
        
        function saveGroupToExcel(table, account, deviceType, range) {
            const wb = XLSX.utils.book_new();
            const metaData = [
                ['Группировка данных'],
                ['Номер квитанции/счета:', account],
                ['Тип прибора:', deviceType],
                ['Диапазон:', range],
                [],
                ['Данные приборов']
            ];
            
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.sheet_add_aoa(ws, metaData, { origin: 'A1' });
            XLSX.utils.book_append_sheet(wb, ws, 'Наклейки');
            
            const fileName = `Наклейки_${account || 'Без номера'}_${deviceType || 'Без типа'}_${range || 'Без диапазона'}.xlsx`
                .replace(/[^\wа-яА-Я\s-]/gi, '_')
                .substring(0, 100);
            
            XLSX.writeFile(wb, fileName);
        }
        
        function saveAllData() {
            const table = document.getElementById('outputTable');
            if (!table) return;
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Все наклейки');
            
            const stickerNumber = document.getElementById('stickerNumber').value;
            const size = document.getElementById('size').value;
            const fileName = `Наклейки_${stickerNumber}_${size}мм.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }
        
        function saveDataToLocalStorage() {
            const table = document.getElementById('outputTable');
            if (!table) return;
            
            const stickerNumber = document.getElementById('stickerNumber').value;
            const size = document.getElementById('size').value;
            
            localStorage.setItem('stickerNumber', stickerNumber);
            localStorage.setItem('size', size);
            localStorage.setItem('stickerData', table.outerHTML);
        }
        
        function loadSavedData() {
            const savedData = localStorage.getItem('stickerData');
            if (savedData) {
                document.getElementById('tableContainer').innerHTML = savedData;
                document.getElementById('stickerNumber').value = localStorage.getItem('stickerNumber') || '';
                document.getElementById('size').value = localStorage.getItem('size') || '16';
                
                document.getElementById('clearData').disabled = false;
                document.getElementById('groupData').disabled = false;
                document.getElementById('fillTypes').disabled = false;
                document.getElementById('saveAll').disabled = false;
                
                setupEditableCells();
            }
        }
        
        function clearData() {
            if (!confirm('Вы уверены, что хотите очистить все данные?')) return;
            
            localStorage.removeItem('stickerData');
            localStorage.removeItem('stickerNumber');
            localStorage.removeItem('size');
            document.getElementById('tableContainer').innerHTML = '';
            document.getElementById('clearData').disabled = true;
            document.getElementById('groupData').disabled = true;
            document.getElementById('fillTypes').disabled = true;
            document.getElementById('saveAll').disabled = true;
            document.getElementById('groupData').textContent = 'Сгруппировать';
            isGrouped = false;
            originalTableData = [];
        }
    </script>
</body>
</html>
