<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система инвентаризации имущества</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Библиотека для чтения Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ... (все стили остаются без изменений) ... */
    </style>
</head>
<body>
    <!-- ... (HTML структура остается без изменений) ... -->

    <script>
        // ... (конфигурация и функции аутентификации остаются без изменений) ... 

        // Обработка импорта из Excel - ИСПРАВЛЕННАЯ ВЕРСИЯ
        function handleExcelImport(event) {
            event.preventDefault();
            if (!isAuthenticated) return;
            
            const type = document.getElementById('import-type').value;
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Пожалуйста, выберите файл');
                return;
            }
            
            // Показываем индикатор загрузки
            const importBtn = document.querySelector('#import-form button[type="submit"]');
            const originalText = importBtn.textContent;
            importBtn.textContent = 'Импорт...';
            importBtn.disabled = true;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Проверяем, есть ли листы в файле
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Файл не содержит данных');
                    }
                    
                    // Берем первый лист
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Преобразуем в JSON с заголовками
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log('Данные из Excel:', jsonData); // Для отладки
                    
                    if (!jsonData || jsonData.length <= 1) {
                        throw new Error('Файл не содержит данных (только заголовки или пустой)');
                    }
                    
                    // Пропускаем заголовок (первую строку)
                    const rows = jsonData.slice(1);
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    let errors = [];
                    
                    rows.forEach((row, index) => {
                        try {
                            // Проверяем, что строка содержит достаточно данных (минимум 3 колонки)
                            if (row && row.length >= 3) {
                                const id = generateId(type);
                                
                                // Безопасное извлечение данных с проверками
                                const name = String(row[1] || '').trim();
                                const inventoryNumber = String(row[2] || '').trim();
                                const quantityList = parseInt(row[3]) || 0;
                                const quantityFact = parseInt(row[4]) || quantityList; // По умолчанию равно списку
                                const cabinet = String(row[5] || '').trim();
                                const hasStickerText = String(row[6] || 'да').toLowerCase().trim();
                                const statusText = String(row[7] || 'активен').toLowerCase().trim();
                                
                                // Преобразование наклейки
                                const hasSticker = hasStickerText === 'да' || 
                                                 hasStickerText === 'есть' || 
                                                 hasStickerText === 'true' || 
                                                 hasStickerText === '1' ||
                                                 hasStickerText === 'yes';
                                
                                // Преобразование статуса
                                let status = 'active';
                                if (statusText.includes('списан') || statusText === 'writtenoff') {
                                    status = 'writtenoff';
                                } else if (statusText.includes('списание') || statusText === 'writeoff') {
                                    status = 'writeoff';
                                }
                                
                                // Проверяем, что обязательные поля заполнены
                                if (name && inventoryNumber) {
                                    // Проверяем, нет ли уже такого номенклатурного номера
                                    const existingItemIndex = inventoryData[type].findIndex(item => 
                                        item.inventoryNumber === inventoryNumber
                                    );
                                    
                                    if (existingItemIndex === -1) {
                                        // Добавляем новый элемент
                                        inventoryData[type].push({
                                            id,
                                            name,
                                            inventoryNumber,
                                            quantityList: Math.max(0, quantityList),
                                            quantityFact: Math.max(0, quantityFact),
                                            cabinet,
                                            location: cabinet ? 'Не указано' : 'Общее',
                                            hasSticker,
                                            status
                                        });
                                        importedCount++;
                                    } else {
                                        // Обновляем существующий элемент
                                        inventoryData[type][existingItemIndex] = {
                                            ...inventoryData[type][existingItemIndex],
                                            name,
                                            quantityList: Math.max(0, quantityList),
                                            quantityFact: Math.max(0, quantityFact),
                                            cabinet,
                                            location: cabinet ? 'Не указано' : 'Общее',
                                            hasSticker,
                                            status
                                        };
                                        importedCount++;
                                    }
                                } else {
                                    skippedCount++;
                                    errors.push(`Строка ${index + 2}: Отсутствует наименование или номенклатурный номер`);
                                }
                            } else {
                                skippedCount++;
                                if (row && row.length > 0) {
                                    errors.push(`Строка ${index + 2}: Недостаточно данных (только ${row.length} колонок)`);
                                }
                            }
                        } catch (error) {
                            skippedCount++;
                            errors.push(`Строка ${index + 2}: ${error.message}`);
                        }
                    });
                    
                    // Сохраняем данные только если что-то импортировалось
                    if (importedCount > 0) {
                        saveData();
                        renderTables();
                    }
                    
                    closeImportModal();
                    
                    // Формируем сообщение о результате
                    let message = `Импорт завершен!\nУспешно обработано: ${importedCount} записей`;
                    if (skippedCount > 0) {
                        message += `\nПропущено: ${skippedCount} записей`;
                    }
                    if (errors.length > 0) {
                        message += `\n\nОшибки:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... и еще ${errors.length - 5} ошибок`;
                        }
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('Ошибка при обработке Excel файла:', error);
                    let errorMessage = 'Ошибка при обработке Excel файла. ';
                    
                    if (error.message.includes('не содержит данных')) {
                        errorMessage += 'Файл пустой или не содержит данных.';
                    } else if (error.message.includes('Corrupt')) {
                        errorMessage += 'Файл поврежден или имеет неподдерживаемый формат.';
                    } else {
                        errorMessage += `Проверьте формат файла. Детали: ${error.message}`;
                    }
                    
                    alert(errorMessage);
                } finally {
                    // Восстанавливаем кнопку
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                }
            };
            
            reader.onerror = function(error) {
                console.error('Ошибка при чтении файла:', error);
                alert('Ошибка при чтении файла. Файл может быть поврежден.');
                
                // Восстанавливаем кнопку
                const importBtn = document.querySelector('#import-form button[type="submit"]');
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            };
            
            // Читаем файл как ArrayBuffer
            reader.readAsArrayBuffer(file);
        }

        // Альтернативная функция для тестирования - создание тестового Excel файла
        function createTestExcelFile() {
            // Создаем тестовые данные
            const testData = [
                ['№', 'Наименование', 'Номенклатурный номер', 'Количество по списку', 'Количество по факту', 'Кабинет', 'Наклейка', 'Статус'],
                [1, 'Компьютер', 'PC-001', 5, 5, '101', 'Да', 'Активен'],
                [2, 'Принтер', 'PRN-001', 3, 2, '102', 'Нет', 'На списание'],
                [3, 'Монитор', 'MON-001', 10, 8, '103', 'Да', 'Активен'],
                [4, 'Стол', 'TBL-001', 15, 15, '', 'Да', 'Активен']
            ];
            
            // Создаем workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(testData);
            
            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Тестовые данные');
            
            // Сохраняем файл
            XLSX.writeFile(wb, 'тестовые_данные_инвентаризация.xlsx');
        }

        // Добавляем кнопку для создания тестового файла (для отладки)
        function addTestButton() {
            const testBtn = document.createElement('button');
            testBtn.textContent = 'Скачать тестовый Excel файл';
            testBtn.className = 'btn btn-info';
            testBtn.style.marginLeft = '10px';
            testBtn.onclick = createTestExcelFile;
            
            const mainControls = document.querySelector('#inventory-tab .inventory-section:first-child .controls > div');
            if (mainControls) {
                mainControls.appendChild(testBtn);
            }
        }

        // Обновляем инициализацию для добавления тестовой кнопки
        function init() {
            // ... (остальная инициализация без изменений) ...
            
            // Добавляем тестовую кнопку после загрузки
            setTimeout(addTestButton, 1000);
            
            // ... (остальные обработчики событий) ...
        }

        // ... (остальные функции без изменений) ...
    </script>
</body>
</html>
