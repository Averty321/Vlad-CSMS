<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление эталонами</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        button {
            margin-right: 10px;
        }
        table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            background-color: #f0f8ff; /* Цвет фона таблицы */
        }
        th, td {
            border: 1px solid #007bff; /* Цвет границы */
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff; /* Синяя заливка заголовков */
            color: white; /* Цвет текста заголовков */
        }
        .actions {
            display: flex;
            gap: 5px;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 1000;
            width: 300px;
        }
        .expired {
            background-color: #ffcccc; /* Красный цвет для просроченных эталонов */
        }
    </style>
</head>
<body>

    <button id="createRoom">Создать расположение</button>
    <button id="manageRooms">Управление расположениями</button>
    <button id="openAddStandard">Добавить эталон</button>

    <table id="items">
        <thead>
            <tr>
                <th>Наименование</th>
                <th>Номер</th>
                <th>Дата</th>
                <th>Вид метрологической оценки</th>
                <th>Расположение</th>
                <th>Осталось дней</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="addStandardModal">
        <h3>Добавить эталон</h3>
        <label for="roomSelect">Расположение:</label>
        <select id="roomSelect" required></select>
        <label for="standardName">Наименование:</label>
        <input type="text" id="standardName" required>
        <label for="standardNumber">Номер:</label>
        <input type="text" id="standardNumber" required>
        <label for="standardDate">Дата:</label>
        <input type="date" id="standardDate" required>
        <label for="interval">Межповерочный интервал (месяцы):</label>
        <input type="number" id="interval" required>
        <label for="type">Вид метрологической оценки:</label>
        <select id="type">
            <option value="поверка">Поверка</option>
            <option value="калибровка">Калибровка</option>
        </select>
        <button id="addStandard">Добавить</button>
        <button id="closeModal">Закрыть</button>
    </div>

    <div class="modal" id="manageRoomsModal">
        <h3>Управление расположениями</h3>
        <ul id="roomList"></ul>
        <button id="closeRoomsModal">Закрыть</button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAlMduGeljWyCDj9mje3-ynHiNavAlPC8I",
  authDomain: "vlad-csms-af6df.firebaseapp.com",
  databaseURL: "https://vlad-csms-af6df-default-rtdb.firebaseio.com",
  projectId: "vlad-csms-af6df",
  storageBucket: "vlad-csms-af6df.firebasestorage.app",
  messagingSenderId: "417297799117",
  appId: "1:417297799117:web:07ce2915cbfe0cb1499684",
  measurementId: "G-0EMQB4HYSQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        interface Standard {
            name: string;
            number: string;
            date: string;
            type: string;
            room: string;
            expirationDate: string;
            daysLeft: number;
        }

        let standards: Standard[] = [];
        let rooms: string[] = [];
        let roomKeys: string[] = [];

        function updateRoomSelect(): void {
            const roomSelect = document.getElementById('roomSelect') as HTMLSelectElement;
            roomSelect.innerHTML = '';
            rooms.forEach((room, index) => {
                const option = document.createElement('option');
                option.value = roomKeys[index]; // Используем ключ Firebase в качестве значения
                option.textContent = room;
                roomSelect.appendChild(option);
            });
        }

        document.getElementById('createRoom')?.addEventListener('click', () => {
            const roomName = prompt('Введите название расположения:');
            if (roomName && roomName.trim() !== '') {
                push(ref(database, 'rooms'), roomName)
                    .then(() => {
                        alert(`Расположение "${roomName}" создано!`);
                    })
                    .catch((error) => {
                        console.error("Error creating room:", error);
                        alert('Ошибка при создании расположения!');
                    });
            } else {
                alert('Название расположения не может быть пустым!');
            }
        });

        document.getElementById('manageRooms')?.addEventListener('click', () => {
            (document.getElementById('overlay') as HTMLElement).style.display = 'block';
            (document.getElementById('manageRoomsModal') as HTMLElement).style.display = 'block';
            renderRoomList();
        });

        function renderRoomList(): void {
            const roomList = document.getElementById('roomList') as HTMLUListElement;
            roomList.innerHTML = '';
            rooms.forEach((room, index) => {
                const li = document.createElement('li');
                li.textContent = room;
                li.innerHTML += `
                    <button onclick="editRoom('${roomKeys[index]}')">Изменить</button>
                    <button onclick="deleteRoom('${roomKeys[index]}')">Удалить</button>
                `;
                roomList.appendChild(li);
            });
        }

        (window as any).editRoom = function(key: string): void {
            const newName = prompt('Введите новое название расположения:');
            if (newName && newName.trim() !== '') {
                const roomRef = ref(database, `rooms/${key}`);
                set(roomRef, newName)
                    .then(() => {
                        renderRoomList();
                        updateRoomSelect();
                    })
                    .catch((error) => {
                        console.error("Error editing room:", error);
                        alert('Ошибка при изменении расположения!');
                    });
            } else {
                alert('Название расположения не может быть пустым!');
            }
        };

        (window as any).deleteRoom = function(key: string): void {
    const isUsed = standards.some(standard => standard.room === key);

    if (isUsed) {
        alert('Нельзя удалить расположение, так как оно используется в эталонах!');
        return;
    }

    if (confirm('Вы уверены, что хотите удалить расположение?')) {
        const roomRef = ref(database, `rooms/${key}`);
        remove(roomRef)
            .then(() => {
                renderRoomList();
                updateRoomSelect();
            })
            .catch((error) => {
                console.error("Error deleting room:", error);
                alert('Ошибка при удалении расположения!');
            });
    }
};


        document.getElementById('openAddStandard')?.addEventListener('click', () => {
            if (rooms.length === 0) {
                alert('Сначала создайте расположение!');
                return;
            }
            (document.getElementById('overlay') as HTMLElement).style.display = 'block';
            (document.getElementById('addStandardModal') as HTMLElement).style.display = 'block';
        });

        document.getElementById('closeModal')?.addEventListener('click', () => {
            (document.getElementById('overlay') as HTMLElement).style.display = 'none';
            (document.getElementById('addStandardModal') as HTMLElement).style.display = 'none';
        });

        document.getElementById('closeRoomsModal')?.addEventListener('click', () => {
            (document.getElementById('overlay') as HTMLElement).style.display = 'none';
            (document.getElementById('manageRoomsModal') as HTMLElement).style.display = 'none';
        });

        document.getElementById('addStandard')?.addEventListener('click', () => {
            const roomSelect = document.getElementById('roomSelect') as HTMLSelectElement;
            const roomKey = roomSelect.value;
            const name = (document.getElementById('standardName') as HTMLInputElement).value.trim();
            const number = (document.getElementById('standardNumber') as HTMLInputElement).value.trim();
            const dateValue = (document.getElementById('standardDate') as HTMLInputElement).value;
            const interval = parseInt((document.getElementById('interval') as HTMLInputElement).value);
            const type = (document.getElementById('type') as HTMLSelectElement).value;

            if (!name || !number || isNaN(interval) || !dateValue || roomKey === "") {
                alert('Пожалуйста, заполните все поля!');
                return;
            }

            const dateInput = new Date(dateValue);
            const expirationDate = new Date(dateInput);
            expirationDate.setMonth(expirationDate.getMonth() + interval);
            const daysLeft = Math.ceil((expirationDate.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));

            const standard: Standard = {
                name,
                number,
                date: dateInput.toISOString(),
                type,
                room: roomKey, // Сохраняем ключ расположения
                expirationDate: expirationDate.toISOString(),
                daysLeft
            };

            push(ref(database, 'standards'), standard)
                .then(() => {
                    (document.getElementById('overlay') as HTMLElement).style.display = 'none';
                    (document.getElementById('addStandardModal') as HTMLElement).style.display = 'none';
                })
                .catch((error) => {
                    console.error("Error adding standard:", error);
                    alert('Ошибка при добавлении эталона!');
                });
        });

        function renderStandards(): void {
            const tbody = document.querySelector('#items tbody') as HTMLTableSectionElement;
            tbody.innerHTML = '';
            standards.forEach((standard, index) => {
                const row = document.createElement('tr');
                if (standard.daysLeft < 0) {
                    row.classList.add('expired');
                }
                row.innerHTML = `
                    <td>${standard.name}</td>
                    <td>${standard.number}</td>
                    <td>${new Date(standard.date).toLocaleDateString()}</td>
                    <td>${standard.type}</td>
                    <td>${getRoomName(standard.room)}</td>
                    <td>${standard.daysLeft}</td>
                    <td class="actions">
                        <button onclick="editStandard('${index}')">Изменить</button>
                        <button onclick="deleteStandard('${index}')">Удалить</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getRoomName(roomKey: string): string {
            const index = roomKeys.indexOf(roomKey);
            return rooms[index] || 'Неизвестно';
        }

        function loadData(): void {
    const roomsRef = ref(database, 'rooms');
    onValue(roomsRef, (snapshot) => {
        rooms = [];
        roomKeys = [];
        snapshot.forEach(childSnapshot => {
            const key = childSnapshot.key;
            const value = childSnapshot.val();
            rooms.push(value);
            roomKeys.push(key || '');
        });
        updateRoomSelect();
        renderRoomList();
    });

    const standardsRef = ref(database, 'standards');
    onValue(standardsRef, (snapshot) => {
        standards = [];
        snapshot.forEach(childSnapshot => {
            standards.push(childSnapshot.val());
        });
        renderStandards();
    });
}


        (window as any).editStandard = function(index: string): void {
            // Логика редактирования эталона
        };

        (window as any).deleteStandard = function(index: string): void {
            if (confirm('Вы уверены, что хотите удалить эталон?')) {
                // Логика удаления эталона
            }
        };

        loadData();
    </script>

</body>
</html>
